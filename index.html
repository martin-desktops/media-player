<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fullscreen Drag & Drop Video Player</title>
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  <link rel="manifest" href="manifest.json">
  <style>
    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #111;
      color: white;
      font-family: sans-serif;
      overflow: hidden; /* Prevent scrollbars when video is full */
    }

    #dropzone {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column; /* To stack drop text and button */
      align-items: center;
      justify-content: center;
      text-align: center;
      border: 4px dashed #666;
      color: #aaa;
      cursor: pointer;
      z-index: 10;
      padding: 20px;
    }

    #player-container {
      width: 100%;
      height: 100%;
      display: flex; /* for centering video if not fullscreen */
      align-items: center;
      justify-content: center;
    }

    video {
      display: none; /* Hidden by default */
      max-width: 100%; /* Ensure video fits container width */
      max-height: 100%; /* Ensure video fits container height */
      border-radius: 10px; /* Can be overridden by Plyr */
    }

    video.show {
      display: block;
    }

    #trim-button {
      background-color: #4CAF50; /* Green */
      border: none;
      color: white;
      padding: 10px 20px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin-top: 20px; /* Space above the button */
      cursor: pointer;
      border-radius: 5px;
      z-index: 11; /* Ensure it's above dropzone text if overlapping slightly */
    }
    #trim-button:hover {
        background-color: #45a049;
    }
  </style>
</head>
<body>
  <div id="dropzone">
    <span>Drop a video file anywhere or click to select</span>
    <button id="trim-button">Open Video Trimmer (E)</button>
  </div>
  <div id="player-container">
    <video id="player" playsinline controls></video>
  </div>

  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
  <script>
    const playerElement = document.getElementById('player');
    const player = new Plyr(playerElement, {
      controls: ['play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'fullscreen'],
      settings: ['speed'],
      keyboard: { focused: true, global: true },
    });

    const dropzone = document.getElementById('dropzone');
    const trimButton = document.getElementById('trim-button');
    const videoTrimAppUrl = 'https://videotrim.app/';

    function openVideoTrimmer() {
        window.open(videoTrimAppUrl, '_blank');
    }

    trimButton.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent dropzone click from firing
        openVideoTrimmer();
    });

    function loadFile(file) {
      if (!file || !file.type.startsWith('video/')) {
        console.error('Invalid file type provided:', file ? file.type : 'undefined');
        // Adjust to target the span inside dropzone for text content
        const dropzoneText = dropzone.querySelector('span');
        if (dropzoneText) {
            dropzoneText.textContent = 'Invalid file. Please drop an MP4 video.';
        }
        dropzone.style.borderColor = '#f44336'; // Red border for error
        setTimeout(() => {
          if (dropzoneText) {
              dropzoneText.textContent = 'Drop a video file anywhere or click to select';
          }
          dropzone.style.borderColor = '#666';
        }, 3000);
        return;
      }

      const url = URL.createObjectURL(file);
      playerElement.src = url;
      playerElement.classList.add('show');
      dropzone.style.display = 'none'; // Hide the entire dropzone, including the button

      player.once('ready', () => {
        player.play();
      });
      if(player.ready) {
        player.play();
      }
    }

    dropzone.addEventListener('click', (e) => {
      // Prevent triggering file dialog if the button was clicked
      if (e.target === trimButton) {
        return;
      }
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'video/mp4,video/*';
      input.onchange = ev => {
        if (ev.target.files && ev.target.files.length > 0) {
          loadFile(ev.target.files[0]);
        }
      };
      input.click();
    });

    ['dragenter', 'dragover'].forEach(evt => dropzone.addEventListener(evt, e => {
      e.preventDefault();
      e.stopPropagation();
      dropzone.style.borderColor = '#4fc3f7';
    }));

    ['dragleave', 'drop'].forEach(evt => dropzone.addEventListener(evt, e => {
      e.preventDefault();
      e.stopPropagation();
      dropzone.style.borderColor = '#666';
    }));

    dropzone.addEventListener('drop', e => {
      if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
        loadFile(e.dataTransfer.files[0]);
        if (e.dataTransfer.items) {
          e.dataTransfer.items.clear();
        } else {
          e.dataTransfer.clearData();
        }
      }
    });

    document.addEventListener('keydown', e => {
      const activeElement = document.activeElement;
      const isInputFocused = activeElement && (activeElement.tagName.toLowerCase() === 'input' ||
                                activeElement.tagName.toLowerCase() === 'textarea' ||
                                activeElement.isContentEditable ||
                                activeElement.closest('.plyr__controls'));

      if (isInputFocused && e.key.toLowerCase() !== 'e') return; // Allow 'e' even if focused, unless it's a text input for typing 'e'

      // New keybind for 'e' - generally available
      if (e.key.toLowerCase() === 'e') {
        // Check if the focus is on a text input field; if so, don't open the trimmer.
        // This is a more specific check for 'e' to avoid hijacking typing.
        if (activeElement && (activeElement.tagName.toLowerCase() === 'input' && activeElement.type !== 'button' && activeElement.type !== 'submit' && activeElement.type !== 'range') || activeElement.tagName.toLowerCase() === 'textarea' || activeElement.isContentEditable) {
            // Do nothing if user is likely typing 'e' into an input field.
        } else {
            e.preventDefault();
            openVideoTrimmer();
            return; // Key handled, exit
        }
      }

      // Only apply custom video shortcuts if video is loaded
      if (!playerElement.classList.contains('show') || player.source == null) return;

      // Existing video player shortcuts
      switch (e.key.toLowerCase()) { // Use toLowerCase for case-insensitivity
        case 'arrowleft':
          e.preventDefault();
          player.currentTime = Math.max(0, player.currentTime - 5);
          break;
        case 'arrowright':
          e.preventDefault();
          player.currentTime = Math.min(player.duration, player.currentTime + 5);
          break;
        case '[':
          e.preventDefault();
          player.speed = Math.max(0.25, player.speed - 0.25);
          break;
        case ']':
          e.preventDefault();
          player.speed = Math.min(4, player.speed + 0.25);
          break;
        case 'r':
          e.preventDefault();
          player.speed = 1.0;
          break;
        case ' ': // Space bar for play/pause
            e.preventDefault();
            player.togglePlay();
          break;
        case 'f': // Fullscreen toggle
            e.preventDefault();
            player.fullscreen.toggle();
          break;
        case 'm': // Mute toggle
            e.preventDefault();
            player.muted = !player.muted;
          break;
      }
    });

    if ('launchQueue' in window) {
      launchQueue.setConsumer(async (launchParams) => {
        if (launchParams.files && launchParams.files.length > 0) {
          const fileHandle = launchParams.files[0];
          const file = await fileHandle.getFile();
          loadFile(file);
        }
      });
    }

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          })
          .catch(err => {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }
  </script>
</body>
</html>